#!/bin/bash
#
# WWIV Build Script.
#
# Required Variables:
#   WORKSPACE - Jenkins workspace
#   BUILD_NUMBER - Jenkins Build number

rm ${WORKSPACE}/wwiv-*.tar.gz || /bin/true

set -e

declare -r CMAKE_BINARY_DIR="${WORKSPACE}/_build"
declare -r WWIV_RELEASE_DIR="${CMAKE_BINARY_DIR}/release"
declare -r WWIV_INSTALL_SRC="${WORKSPACE}/install"
declare -r WWIV_RELEASE="5.5"
declare -r WWIV_FULL_RELEASE="5.5.0"
declare -r WWIV_RELEASE_ARCHIVE_FILE=${WORKSPACE}/wwiv-linux-${label}-${WWIV_RELEASE}.${BUILD_NUMBER}.tar.gz
declare -r CTEST_BIN=ctest
declare -r CMAKE_BIN=cmake
echo "WWIV BBS Build"
echo "Workspace:        ${WORKSPACE}"
echo "CMake:            ${CMAKE_BIN}"
echo "CTest:            ${CTEST_BIN}"
echo "CMake Build:      ${CMAKE_BINARY_DIR}"
echo "Release Dir:      ${WWIV_RELEASE_DIR}"
echo "WWI Full Release: ${WWIV_FULL_RELEASE}"
echo "WWIV Release:     ${WWIV_RELEASE}"
echo "Version:          ${BUILD_NUMBER}"
echo "Archive:          ${WWIV_RELEASE_ARCHIVE_FILE}"
echo "Label:            ${label}"
echo "GCC:              $(gcc --version)"

echo "Ensuring CMAKE_BINARY_DIR exists: (${CMAKE_BINARY_DIR})"
if [[ ! -d "${CMAKE_BINARY_DIR}" ]]; then
  mkdir -p "${CMAKE_BINARY_DIR}"
fi
echo "Created binary dir: ${CMAKE_BINARY_DIR}"

if [[ -r "${CMAKE_BINARY_DIR}/CMakeCache.txt" ]] ;then
   rm ${CMAKE_BINARY_DIR}/CMakeCache.txt
fi

echo "Cleaning up release dir (${WWIV_RELEASE_DIR})"
if [[ -d "${WWIV_RELEASE_DIR}" ]]; then
  rm -rf "${WWIV_RELEASE_DIR}"
fi
mkdir -p "${WWIV_RELEASE_DIR}"
echo "Created release dir: ${WWIV_RELEASE_DIR}"

echo "Building binaries"

echo "Compiling Everything"
if [[ ! -d "${CMAKE_BINARY_DIR}" ]]; then
    mkdir -p ${CMAKE_BINARY_DIR}
fi

pushd ${CMAKE_BINARY_DIR}
${CMAKE_BIN} -G "Ninja" -DCMAKE_BINARY_DIR_TYPE=Debug ..
${CMAKE_BIN} --build . --config Debug
${CTEST_BIN} --no-compress-output -T Test -V || /bin/true
popd
cd ${WORKSPACE}

echo "Populating built binaries"
cp  ${CMAKE_BINARY_DIR}/bbs/bbs \
    ${CMAKE_BINARY_DIR}/network/network \
    ${CMAKE_BINARY_DIR}/networkb/networkb \
    ${CMAKE_BINARY_DIR}/networkc/networkc \
    ${CMAKE_BINARY_DIR}/networkf/networkf \
    ${CMAKE_BINARY_DIR}/networkt/networkt \
    ${CMAKE_BINARY_DIR}/network1/network1 \
    ${CMAKE_BINARY_DIR}/network2/network2 \
    ${CMAKE_BINARY_DIR}/network3/network3 \
    ${CMAKE_BINARY_DIR}/wwivconfig/wwivconfig \
    ${CMAKE_BINARY_DIR}/wwivd/wwivd \
    ${CMAKE_BINARY_DIR}/wwivutil/wwivutil \
    ${WWIV_RELEASE_DIR}

echo "adding common files"

echo "adding linux-specific files"
cd ${WWIV_INSTALL_SRC}/platform/unix
shopt -s dotglob
cp -a * ${WWIV_RELEASE_DIR}
shopt -u dotglob

echo "Creating release archive: ${WWIV_RELEASE_ARCHIVE_FILE}"
cd ${WWIV_RELEASE_DIR}
shopt -s dotglob
tar zcvf ${WWIV_RELEASE_ARCHIVE_FILE} * 
shopt -u dotglob

echo "Archive file: ${WWIV_RELEASE_ARCHIVE_FILE}"
echo "File Contents:"
tar ztvf ${WWIV_RELEASE_ARCHIVE_FILE}
